<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Markdown Browser</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.4/cosmo/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/sunburst.min.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.9.3/lodash.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: {
      displayMath: [["$$","$$"],["\\[","\\]"]],
      inlineMath: [['\\\\(','\\\\)']],
      processEscapes: true
    }});
  </script>
  <style>
    body {
      position:relative; /*for scrollspy*/
      padding-top: 70px; /*to keep nav bar from overlapping*/
    }
    main#content {
      padding-left:1em;
      padding-right:1em;
    }
    nav#toc ul ul {
      padding-left:1em;
    }
    nav#toc li > a {
      padding: 2px 10px;
    }
    nav#toc li li > a {
      font-size: 0.8em;
    }
    nav#toc li.active > a {
      color: purple;
      font-weight: bolder;
      border-left: 3px solid purple;
    }
    /* only show children of active element */
    nav#toc li        ul {display: none }
    nav#toc li.active ul {display: block}
  </style>
</head>
<body data-spy="scroll" data-target="#toc">
  <header class="hidden-print">
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-container">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Markdown Browser</a>
        </div>
        <div class="collapse navbar-collapse" id="navbar-container">
          <ul class="nav navbar-nav"></ul>
        </div>
      </div>
    </nav>
  </header>
  <div class="container">
    <div class="row">
      <main id="content" class="col-md-9" role="main"></main>
      <div class="col-md-3 hidden-print" role="complementary">
        <nav id="toc" class="col-md-3 affix"></nav>
      </div>
    </div>
  </div>
  <script type="text/javascript">

    ///////////////////////
    // PROCESS FILE MENU //
    ///////////////////////

    jQuery(function(){$.ajax('files').success(function(x) {

      // convert into grouped lists
      x = _.chain(x.replace(/^\.\//mg,'').split('\n')) // clear ./ and split on newlines
        .filter(function(a){return a.length>0})        // remove empty entries
        .groupBy(function(a){                          // group by top-level directory
          return a.match('/') ? a.split('/')[0] : 'Unsorted'
        }).value()

      // convert into HTML unordered list
      var ul = '';
      _.each(x, function(v,k){
        ul += '<li><a href="#">'+k+'</a><ul>\n'+_.map(v, function(a){
          return '  <li><a href="index.html?'+a+'">'+a.replace(/.*?\/(.*?)(\.md?)$/,'$1')+'</a></li>\n'
        }).join('') + "</ul></li>";
      })

      // create menu bar
      $el = $('nav.navbar ul.nav').html(ul);
      $el.children('li')
        .addClass('dropdown')
        .children('ul')
          .addClass('dropdown-menu')
          .attr({role:'menu'});
      $el.children('li').children('a')
        .addClass('dropdown-toggle')
        .attr({'data-toggle':'dropdown','role':'button','aria-expanded':'false'})
        .each(function(){ $(this).html( $(this).html() + ' <span class="caret"></span>' )});

      // create navigation page (if no page has been loaded)
      if(!document.URL.split('?')[1]){
        $('main').html(ul);
      }
    })});


    /////////////////////
    // PROCESS CONTENT //
    /////////////////////

    jQuery(function(){
      var mdFile = document.URL.split('?')[1];
      if (mdFile){$.ajax(mdFile).success(function(x) {

        // capture latex blocks
        var latex = x.match(/(\\\\\([^]*?\\\\\))|(\$\$[^]*?\$\$)/g);

        // populate page
        $('main').html(marked(x
          .replace(/\r?\n/g, '\n') // standardize line breaks to /n
          .replace(/(\\\\\([^]*?\\\\\))|(\$\$[^]*?\$\$)/g, '<latex />') // escape latex
          .replace(/\[TOC\]/gi, '<toc></toc>') // TOC jQuery can find
        ));

        // return latex to page
        $('main latex').each(function(){ $(this).text(latex.shift()) });

        // create table of contents if applicable
        var toc = marked(
          $(':header').not('h1').map(function(){
            var level = parseInt($(this).prop("tagName").slice(1));
            return Array(1+2*(level-1)).join(' ') + "* ["+$(this).html()+"](#"+$(this).attr('id')+")";
          }).toArray().join('\n'));
        $('nav#toc').append(toc).find('ul').addClass('nav');
        $('main toc').html(toc).addClass('visible-xs-block').addClass('hidden-print');

        // update nav bar with scrolling
        $('body').scrollspy({target:'#toc'});

        // add latex processor if applicable
        if ($('main latex')) {
          $.getScript('https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML');
        }

        // style tables
        $('main#content table').addClass('table table-striped table-hover');
        $('main#content thead').addClass('btn-primary');

        // perform syntax highlighting
        $('pre code').each(function(i, block) { hljs.highlightBlock(block); });
      })}
    });

  </script>
</body>
</html>
