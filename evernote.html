<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Markdown Browser</title>
  <link rel="stylesheet" href="lib/bootswatch-cosmo.min.css" />
  <script type="text/javascript" src="lib/jquery.min.js"></script>
  <script type="text/javascript" src="lib/lodash.min.js"></script>
  <script type="text/javascript" src="markdown.js"></script>
  <script type="text/javascript" src="/lib/evernote-sdk-minified.js"></script>
  <script type="text/javascript" src="/lib/jsOAuth-1.3.7.min.js"></script>
  <script type="text/javascript" src="evernote.js"></script>
  <script type="text/javascript">

    /*
     * Startup
     */

    function fetchNote(guid) {
      EN.fetchNoteContent(guid, function(note){
        $('main').html(markdown.toHTML(note));
      })
    }

    function populateList(notes) {
      var notebooks = _.chain(EN.getNoteData()).pluck('notebook').unique().sort().value();
      var groupedNotes = _.groupBy(EN.getNoteData(), 'notebook');
      $('ul.list-group').off('click').empty();
      for (var i = 0; i < notebooks.length; i++) {
        var notebook = notebooks[i];
        $('ul.list-group').append('<li class="list-group-item active">' + notebook + '</li>');
        var notes = _.sortBy(groupedNotes[notebook], 'title');
        for (var j = 0; j < notes.length; j++) {
          var note = notes[j];
          $('ul.list-group').append('<a href="#" class="list-group-item" data-guid="'+note.guid+'" style="padding:2px 15px;">' + note.title + '</a>');
        }
      }
      $('ul.list-group').on('click', 'a', window.clickHandler);
    }

    function clickHandler() {
      $('a.list-group-item.disabled').removeClass('disabled');
      var guid = $(this).data('guid');
      $(this).addClass('disabled');
      fetchNote(guid);
    }

    if (localStorage.getItem('token') === null) {
      alert('Token not set!')
    } else {
      window.EN = new EvernoteConnection(localStorage.getItem('token'));
      EN.fetchData(function(notes){
        populateList(notes.notes);
      })
    }

  </script>
</head>
<body data-spy="scroll" data-target="#toc">
  <div class="container-fluid">
    <div class="row">
      <section id="nav-list" class="col-md-2" role="complientary">
        <ul class="list-group">
          <li class="list-group-item">
            <span class="badge">14</span>
            Cras justo odio
          </li>
          <li class="list-group-item">
            <span class="badge">2</span>
            Dapibus ac facilisis in
          </li>
          <li class="list-group-item">
            <span class="badge">1</span>
            Morbi leo risus
          </li>
        </ul>
      </section>
      <main id="content" class="col-md-8" role="main">
        <textarea id="editor"></textarea>
      </main>
    </div>
  </div></body>
</html>
