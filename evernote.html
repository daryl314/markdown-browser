<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Markdown Browser</title>
  <link rel="stylesheet" href="lib/bootswatch-cosmo.min.css" />
  <script type="text/javascript" src="lib/jquery.min.js"></script>
  <script type="text/javascript" src="markdown.js"></script>
  <script type="text/javascript" src="/lib/evernote-sdk-minified.js"></script>
  <script type="text/javascript" src="/lib/jsOAuth-1.3.7.min.js"></script>
  <script type="text/javascript">

    /////////////////////////////////////////////////
    // CONTAINER OBJECT FOR AN EVERNOTE CONNECTION //
    /////////////////////////////////////////////////

    EvernoteConnection = function(){

      // constructor
      var EvernoteConnection = function(token){
        if (token === undefined) {
          throw new Error('Authentication token required!');
        } else {
          this.authenticationToken = token;
          var noteStoreURL = "proxy-https/www.evernote.com/shard/s2/notestore";
          var noteStoreTransport = new Thrift.BinaryHttpTransport(noteStoreURL);
          var noteStoreProtocol = new Thrift.BinaryProtocol(noteStoreTransport);
          this.noteStore = new NoteStoreClient(noteStoreProtocol);
        }
      }

      // error handler
      EvernoteConnection.prototype._errorHandler = function(error) {
        console.error(error);
      }

      // return a filter for markdown notes
      EvernoteConnection.prototype._markdownFilter = function() {
        return new NoteFilter({
          tagGuids: [
            this._getTag('markdown')
          ],
          order: NoteSortOrder.TITLE
        });
      }

      // function to fetch notebook data
      EvernoteConnection.prototype._fetchNotebookData = function(callback) {
        var _this = this;
        var cb = function(notebooks) {
          _this.notebooks = notebooks;
          console.log('Fetched Evernote notebook data');
          if (callback) callback(notebooks);
        };
        this.noteStore.listNotebooks(this.authenticationToken, cb, this._errorHandler);
      }

      // function to fetch tag data
      EvernoteConnection.prototype._fetchTagData = function(callback) {
        var _this = this;
        var cb = function(tags) {
          _this.tags = tags;
          console.log('Fetched Evernote tag data');
          if (callback) callback(tags);
        }
        this.noteStore.listTags(this.authenticationToken, cb, this._errorHandler)
      }

      // function to fetch note data
      EvernoteConnection.prototype._fetchNoteData = function(noteFilter, start, callback) {
          var _this = this;
          var cb = function(notes) {
            _this.notes = _this.notes.concat(notes.notes);
            console.log('Fetched Evernote note data');
            if (_this.notes.length < notes.totalNotes) {
              _this._fetchNoteData(noteFilter, _this.notes.length, callback);
            } else {
              if (callback) callback(notes);
            }
          }

          if (start == 0) {
            this.notes = []; // clear list if starting a new fetch
          }

          this.noteStore.findNotesMetadata(    // search for notes...
            this.authenticationToken,     //   authentication token
            noteFilter,                   //   passed note serach filter
            start,                        //   starting index
            100,                          //   max notes to return
            new NotesMetadataResultSpec({ //   results to return...
              includeTitle: true,         //     with the note title
              includeNotebookGuid: true   //     with the notebook guid
            }),                           //
            cb,                           //   success callback
            this._errorHandler            //   error callback
          )
      }

      // function to return the GUID associated with a tag name
      EvernoteConnection.prototype._getTag = function(tagName) {
        for (var i = 0; i < this.tags.length ; i++) {
          if (this.tags[i].name == tagName) {
            return this.tags[i].guid;
          }
        }
      }

      EvernoteConnection.prototype._stripFormatting = function(txt) {
        return txt
          .replace(/\s*<span.*?>([\S\s]*?)<\/span>\s*/g, '$1')  // clear span tags
          .replace(/\n/g,'')                                    // clear newlines
          .replace(/<\/div>[\s\n]*<div>/g,                      // clear whitespace between div tags
            '</div><div>')
          .replace(/(<\/?div>)+/g,'\n')                         // convert <div> boundaries to newlines
          .replace(/<br.*?>/g,'\n')                             // convert <br> to newlines
          .replace(/<.*?>/g,'')                                 // strip any remaining tags
          .replace(/&nbsp;/g,' ')                               // &nbsp; -> ' '
          .replace(/&lt;/g,'<')                                 // &lt;   -> '<'
          .replace(/&gt;/g,'>')                                 // &gt;   -> '>'
          .replace(/&apos;/g,"'")                               // &apos; -> "'"
          .replace(/&quot;/g,'"')                               // &quot; -> '"'
          .replace(/&#124;/g, '|')                              // &#124; -> '|'
          .replace(/&amp;/g,'&')                                // &amp;  -> '&'
      }

      EvernoteConnection.prototype._addFormatting = function(txt) {
        return '<?xml version="1.0" encoding="UTF-8"?>' +
          '<!DOCTYPE en-note SYSTEM "http://xml.evernote.com/pub/enml2.dtd">' +
          '<en-note>' +
            txt
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/(.+)/mg, '<div>$1</div>')
              .replace(/^$/mg, '<div><br /></div>')
            +
          '</en-note>'
      }

      EvernoteConnection.prototype._createNote = function(title, content, callback) {
        if (title   === undefined) throw new Error('Title is required to create a note!');
        if (content === undefined) throw new Error('Content is required to create a note!');
        var note = new Note();
        note.title = title;
        note.content = this._addFormatting(content);
        this.noteStore.createNote(this.authenticationToken, note, function(note, err) {
          if (err) {
            console.error('Note creation error!');
            console.error(err);
          } else {
            console.log('Note created!');
            console.log(note);
            if (callback) callback(note);
          }
        });
      }

      EvernoteConnection.prototype._updateNote = function(title, content, guid, callback) {
        if (guid    === undefined) throw new Error('GUID is required to create a note!');
        if (title   === undefined) throw new Error('Title is required to create a note!');
        if (content === undefined) throw new Error('Content is required to create a note!');

        var note = new Note();
        note.guid = guid;
        note.title = title;
        note.content = this._addFormatting(content);
        note.tagNames = ['markdown'];

        this.noteStore.updateNote(this.authenticationToken, note, function(note, err) {
          if (err) {
            console.error('Note update error!');
            console.error(err);
          } else {
            console.log('Note updated!');
            console.log(note);
            if (callback) callback(note);
          }
        });
      }

      // function to fetch data
      EvernoteConnection.prototype.fetchData = function(callback) {
        var _this = this;
        _this._fetchNotebookData(function(){
          _this._fetchTagData(function(){
            _this._fetchNoteData(_this._markdownFilter(), 0,
              callback
            )
          })
        });
      }

      // function to fetch note content
      EvernoteConnection.prototype.fetchNoteContent = function(guid, callback) {
        console.log('Fetching note: '+guid);
        this.noteStore.getNoteContent(
          this.authenticationToken,
          guid,
          callback,
          this._errorHandler
        );
      }

      // return the nested item
      return EvernoteConnection;
    }();

    /*
     * Startup
     */

    function fetchNote(guid) {
      EN.fetchNoteContent(guid, function(note){
        $('main').html(markdown.toHTML(EN._stripFormatting(note)));
      })
    }

    function populateList(notes) {
      for (var i = 0; i < notes.length; i++) {
        var note = notes[i];
        $('ul.list-group').prepend('<a href="#" class="list-group-item" data-guid="'+note.guid+'">' + note.title + '</a>');
      }
      $('ul.list-group').on('click', 'a', window.clickHandler);
    }

    function clickHandler() {
      $('a.list-group-item.active').removeClass('active');
      var guid = $(this).data('guid');
      $(this).addClass('active');
      fetchNote(guid);
    }

    if (localStorage.getItem('token') === null) {
      alert('Token not set!')
    } else {
      window.EN = new EvernoteConnection(localStorage.getItem('token'));
      EN.fetchData(function(notes){
        populateList(notes.notes);
      })
    }

  </script>
</head>
<body data-spy="scroll" data-target="#toc">
  <div class="container-fluid">
    <div class="row">
      <section id="nav-list" class="col-md-2" role="complientary">
        <ul class="list-group">
          <li class="list-group-item">
            <span class="badge">14</span>
            Cras justo odio
          </li>
          <li class="list-group-item">
            <span class="badge">2</span>
            Dapibus ac facilisis in
          </li>
          <li class="list-group-item">
            <span class="badge">1</span>
            Morbi leo risus
          </li>
        </ul>
      </section>
      <main id="content" class="col-md-8" role="main">
        <textarea id="editor"></textarea>
      </main>
    </div>
  </div></body>
</html>
