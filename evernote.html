<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Markdown Browser</title>
  <link rel="stylesheet" href="lib/bootswatch-cosmo.min.css" />
  <script type="text/javascript" src="lib/jquery.min.js"></script>
  <script type="text/javascript" src="lib/lodash.min.js"></script>
  <script type="text/javascript" src="markdown.js"></script>
  <script type="text/javascript" src="/lib/evernote-sdk-minified.js"></script>
  <script type="text/javascript" src="/lib/jsOAuth-1.3.7.min.js"></script>
  <script type="text/javascript" src="evernote.js"></script>
  <script type="text/javascript">window.module={};//for diff.js node exports</script><script type="text/javascript" src="diff.js"></script>

  <style>

      body {
        padding: 1em;
      }
      .text-diff {
        white-space: pre;
        font-family: monospace;
        overflow-wrap: break-word;
        font-size: 0.8em;
      }
      table.text-diff, table.text-diff th, table.text-diff td {
        border: 1px solid grey;
        border-collapse: collapse;
      }
      table.text-diff tr.line-equal {
        background-color: whitesmoke
      }
      table.text-diff tr.line-insert {
        background-color: lightgreen
      }
      table.text-diff tr.line-delete {
        background-color: lightpink
      }
      table.text-diff tr.line-change {
        background-color: lavender
      }
      table.text-diff tr.collapsed {
        background-color: cornsilk
      }
      table.text-diff tr.collapsed td {
        text-align: center
      }
      .text-diff span.chunk-equal {

      }
      .text-diff span.chunk-insert {
        background-color: lightgreen
      }
      .text-diff span.chunk-delete {
        background-color: lightpink
      }

  </style>

  <script type="text/javascript">

  /////////////////////////////////////
  // FUNCTION TO COMPARE TEXT BLOCKS //
  /////////////////////////////////////

    function createRow($el, rowClass, a, b, c, d) {
      $el.append(
        '<tr class="' + rowClass + '">' +
          '<td>' + a + '</td>' +
          '<td>' + b + '</td>' +
          '<td>' + c + '</td>' +
          '<td>' + d + '</td>' +
        '</tr>'
      );
    }

    function compareBlocks(text1, text2, title, $container) {

      // function to remap diff format to line format
      function remap(key) {
        if (key == diff.INSERT) {
          return 1;
        } else if (key == diff.EQUAL) {
          return 0;
        } else if (key == diff.DELETE) {
          return -1;
        } else {
          throw new Error('Invalid diff type');
        }
      }

      // default to body for container
      $container = $container || $('body');

      // prepare text area
      if (title) $('<h2>'+title+'</h2>').appendTo($container);
      $table = $('<table class="text-diff">').appendTo($container);

      // compare results
      d = diff(text1, text2);

      // standardize line deletion
      //   OLD: Eq[abc] Del[\ndef] Eq[\nghi]
      //   NEW: Eq[abc\n] Del[def\n] Eq[ghi]
      for (var i = 0; i < d.length-2; i++) {
        if (
            d[i  ][0] == diff.EQUAL  &&
            d[i+1][0] == diff.DELETE &&
            d[i+2][0] == diff.EQUAL  &&
            d[i+1][1][0] == '\n'     &&
            d[i+2][1][0] == '\n'
        ) {
          d[i  ][1] = d[i][1] + '\n';
          d[i+1][1] = d[i+1][1].slice(1) + '\n';
          d[i+2][1] = d[i+2][1].slice(1)
        }
      }

      // convert diff to line-based format
      var lineDiffs = [];
      var currentLine = [];
      for (var i = 0; i < d.length; i++) {

        // split current diff into lines (without trailing newline)
        var lineData = d[i][1].replace(/\n$/, '').split(/\n/);

        // insert/equal/delete key in new format
        var key = remap(d[i][0]);

        // extend current line with new data
        currentLine.push([key, lineData[0]]);

        //
        for (var j = 1; j < lineData.length; j++) {
          lineDiffs.push(currentLine);
          currentLine = [[key, lineData[j]]];
        }

        // terminate current line if block ends with a newline
        if (d[i][1][ d[i][1].length-1 ] == '\n') {
          lineDiffs.push(currentLine);
          currentLine = [];
        }
      }

      // verify correctness of new data -- MERGE WITH WALKER BELOW
      var validateL = '', validateR = '';
      for (var i = 0; i < lineDiffs.length; i++) {
        if (lineDiffs[i].length == 1) {
          if (lineDiffs[i][0][0] == 1) {
            validateR += lineDiffs[i][0][1] + '\n';
          } else if (lineDiffs[i][0][0] == -1) {
            validateL += lineDiffs[i][0][1] + '\n';
          } else {
            validateL += lineDiffs[i][0][1] + '\n';
            validateR += lineDiffs[i][0][1] + '\n';
          }
        } else {
          for (var j = 0; j < lineDiffs[i].length; j++) {
            var delta = lineDiffs[i][j];
            if (delta[0] == 1) {
              validateR += delta[1];
            } else if (delta[0] == -1) {
              validateL += delta[1];
            } else {
              validateL += delta[1];
              validateR += delta[1];
            }
          }
          validateL += '\n';
          validateR += '\n';
        }
      }
      if (validateL != text1)
        console.error('LHS mismatch!');
      else if (validateR != text2)
        console.error('RHS mismatch!');
      else
        console.log('Validation OK');

      // initialize counters for LHS and RHS line number
      var linesL = 0, linesR = 0;

      // display output as table
      for (var i = 0; i < lineDiffs.length; i++) {
        var line = lineDiffs[i];
        if (line.length == 1) {
          if (line[0][0] == 0) {
            createRow($table, 'line-equal', linesL++, line[0][1], linesR++, line[0][1]);
          } else if (line[0][0] == 1) {
            createRow($table, 'line-insert', '', '', linesR++, line[0][1]);
          } else {
            createRow($table, 'line-delete', linesL++, line[0][1], '', '');
          }
        } else {
          var dataL = '', dataR = '';
          for (var j = 0; j < line.length; j++) {
            if (line[j][0] == 0) {
              dataL += '<span class="chunk-equal">' + line[j][1] + '</span>';
              dataR += '<span class="chunk-equal">' + line[j][1] + '</span>';
            } else if (line[j][0] == -1) {
              dataL += '<span class="chunk-delete">' + line[j][1] + '</span>';
            } else {
              dataR += '<span class="chunk-insert">' + line[j][1] + '</span>';
            }
          }
          createRow($table, 'line-change', linesL++, dataL, linesR++, dataR);
        }
      }

      // collapse large blocks of unchanged text
      var tableRows = $table.find('tr');
      for (var i = 0; i < tableRows.length; i++) {
        var $tr = $(tableRows[i]);
        if ($tr.hasClass('line-equal')) {
          var startIndex = i;
          i += 1;
          while ($(tableRows[i]).hasClass('line-equal')) i++;
          if (i - startIndex > 6) {
            for (var j = startIndex+2; j < i-2; j++) {
              $(tableRows[j]).toggle();
            }
            $(tableRows[startIndex+2]).before(
              '<tr class="collapsed" data-lines="' + (i-startIndex-4) + '">' +
                '<td>' + $(tableRows[startIndex+2]).find('td').first().text() + '</td>' +
                '<td colspan="3">+++ ' + (i - startIndex - 4) + ' lines +++</td>' +
              '</tr>'
            );
          }
        }
      }

      // toggle collapsed text
      $table.find('tr.collapsed').on('click', function(){
        $(this).nextAll().slice(0,$(this).data('lines')).toggle()
      })

      // display output as block
      $block = $('<div class="text-diff">').appendTo($container);
      for (var i = 0; i < d.length; i++) {
        text = d[i][1].replace(/\n/g, '<br/>');
        if (d[i][0] == diff.INSERT) {
          $block.append('<span class="chunk-insert">' + text + '</span>');
        } else if (d[i][0] == diff.DELETE) {
          $block.append('<span class="chunk-delete">' + text + '</span>');
        } else {
          $block.append('<span class="chunk-equal">' + text + '</span>');
        }
      }

    }



    /*
     * Startup
     */

    function fetchNote(guid) {
      EN.fetchNoteContent(guid, function(note){
        $('main').html(markdown.toHTML(note));
      })
    }

    function fetchVersions(guid, queue, callback, data) {
      if (data === undefined) data = [];
      if (queue.length == 0) {
        callback(data);
        return;
      }
      EN.noteStore.getNoteVersion(
        EN.authenticationToken,
        guid,
        queue[0],
        false,
        false,
        false,
        function(x){
          data = data.concat(x);
          if (queue.length > 1) {
            fetchVersions(guid, queue.slice(1), callback, data);
          } else {
            callback(data);
          }
        }
      );
    }

    function doCompare() {
      var selectedItems = $('ul.list-group a.active').map( function(){return $(this).data('sequence')} );
      fetchVersions('4c337201-7320-4bf3-a646-ec096796ed16', selectedItems, function(data){
        console.log(data);
        window.noteData = data;
        compareBlocks(
          EN._stripFormatting(noteData[1].content),
          EN._stripFormatting(noteData[0].content),
          'foo',
          $('main#content'))
      })
    }

    if (localStorage.getItem('token') === null) {
      alert('Token not set!')
    } else {
      window.EN = new EvernoteConnection(localStorage.getItem('token'));
      EN.noteStore.listNoteVersions(EN.authenticationToken, '4c337201-7320-4bf3-a646-ec096796ed16', function(versions){
        window.v = versions;
        _.each(versions, function(v){
          $('ul.list-group').append('<a href="#" class="list-group-item" data-sequence="'+v.updateSequenceNum+'" style="padding:2px 15px;">' + new Date(v.updated) + '</a>');
        });
        $('ul.list-group a').on('click', $(this).toggleClass('active'));
      })
    }

    function test() {
      $($('a.list-group-item')[0]).addClass('active');
      $($('a.list-group-item')[4]).addClass('active');
      doCompare();
      t1 = "1234\n567\nasbd\nawefaw\nThis is\nsome test\ntest that\nis going\nto be\nrearranged\n1\n2\n3\n4\n5\n6\n7\n8\n8\n10\n11\n12\n13\n14\n15\n16\n17\n18\nfoo\n\n";
      t2 = t2 = "1234\n567\nabbd\nawefaw\nwefawef\nThis is\nrearranged\nsome test\nis going\nto be\n1\n2\n3\n4\n5\n6\n7\n8\n8\n10\n11\n12\n13\n14\n15\n16\n17\n18\nbar\n\n";
      compareBlocks(t1, t2, 'vim', $('main#content'));
    }

  </script>
</head>
<body data-spy="scroll" data-target="#toc">
  <div class="container-fluid">
    <div class="row">
      <section id="nav-list" class="col-md-3" role="complientary">
        <ul class="list-group">
          <li class="list-group-item">
            <span class="badge">14</span>
            Cras justo odio
          </li>
          <li class="list-group-item">
            <span class="badge">2</span>
            Dapibus ac facilisis in
          </li>
          <li class="list-group-item">
            <span class="badge">1</span>
            Morbi leo risus
          </li>
        </ul>
      </section>
      <main id="content" class="col-md-7" role="main">
        <textarea id="editor"></textarea>
      </main>
    </div>
  </div></body>
</html>
